# WebTransport 1C Addin (Rust)

Внешняя компонента для 1С, объединяющая WebSocket‑клиент и HTTP/SSE сервер с обменом событиями с 1С.

Проект основан на оригинальном репозитории и шаблоне внешней компоненты на Rust:
- Первоисточник: https://github.com/dlyubanevich/websocket1c
- Шаблон компоненты (Rust): https://github.com/medigor/addin1

## Состав и имена классов

Компонента экспортирует 3 класса (имена для `Новый("AddIn.*")`):
- `ws` — WebSocket‑клиент.
- `http` — HTTP/SSE сервер с событиями в 1С.
- `mcp` — HTTP/SSE сервер (тот же API, отдельный класс).

## Общие свойства

### `ОписаниеОшибки`
Текст последней ошибки, полученной при вызове методов компоненты.

## WebSocket‑клиент (`ws`)

Все методы выбрасывают исключение при ошибке. В таком случае используйте `ОписаниеОшибки`.

### `Подключиться(Адрес, Заголовки)`
Устанавливает соединение с сервером.

Параметры:
- `Адрес` — Строка. Адрес сервера, например `ws://127.0.0.1:8080`.
- `Заголовки` — Строка. Пустая строка или JSON‑строка с заголовками.

Возвращает:
- Булево. `Истина`, если соединение установлено.

Примечание: значения заголовков из JSON приводятся к строке. Массивы и объекты заменяются на пустую строку.

### `ОтправитьСообщение(Сообщение)`
Отправляет текстовое сообщение.

Параметры:
- `Сообщение` — Строка.

Возвращает:
- Булево. `Истина`, если сообщение отправлено.

### `ПолучитьСообщение(Таймаут)`
Ожидает сообщение от сервера до истечения таймаута.
Если сообщение не получено, возвращает пустую строку.

Параметры:
- `Таймаут` — Число. Таймаут в миллисекундах.

Возвращает:
- Строка. Сообщение от сервера или пустую строку.

### `Отключиться()`
Закрывает соединение.

### `Версия()`
Возвращает версию компоненты.

## HTTP/SSE сервер (`http` и `mcp`)

Сервер поднимается на заданном адресе и проксирует входящие запросы в 1С через внешние события.
Также поддерживаются SSE‑подключения и отправка событий в них.

### `ЗапуститьHTTP(Адрес)`
Запускает HTTP сервер.

Параметры:
- `Адрес` — Строка. Например `127.0.0.1:8088`.

Возвращает:
- Булево. `Истина`, если сервер запущен.

### `ОстановитьHTTP()`
Останавливает HTTP сервер.

### `ОтправитьHTTPОтвет(Идентификатор, Код, Заголовки, Тело)`
Отправляет ответ на ранее полученный HTTP‑запрос.

Параметры:
- `Идентификатор` — Строка. `id` из события `HTTP`.
- `Код` — Число. HTTP‑статус (100..599).
- `Заголовки` — Строка. JSON‑строка с заголовками.
- `Тело` — Строка. Тело ответа.

Возвращает:
- Булево. `Истина`, если ответ отправлен.

Примечание: ожидание ответа ограничено 30 секундами. Если ответ не получен вовремя, клиент получит `504`.

### `ОтправитьSSE(ИдентификаторСессии, Данные)`
Отправляет событие `message` в SSE‑сессию.

Параметры:
- `ИдентификаторСессии` — Строка. `sessionId` из события `SSE_OPEN`.
- `Данные` — Строка. Текст события.

Возвращает:
- Булево. `Истина`, если отправлено.

### `ЗакрытьSSE(ИдентификаторСессии)`
Закрывает SSE‑сессию.

### `Версия()`
Возвращает версию компоненты.

## События 1С (внешние события)

Компонента публикует внешние события с источником `WebTransport`:

### `HTTP`
Срабатывает на любой HTTP‑запрос, кроме:
- `GET /` (возвращает `MCP server`),
- `GET /sse` (SSE‑подключение),
- `POST /message` (обработчик MCP сообщения).

Полезные данные события — JSON:
- `id` — строка идентификатора запроса.
- `method` — HTTP метод.
- `path` — путь.
- `query` — строка запроса.
- `headers` — объект заголовков.
- `body` — строка тела.

Ответ нужно вернуть через `ОтправитьHTTPОтвет` с этим `id`.

### `SSE_OPEN`
Срабатывает при открытии SSE‑подключения `/sse`.

Полезные данные события — JSON:
- `id` — идентификатор SSE‑сессии.
- `path` — `/sse`.
- `headers` — объект заголовков (пустой).

### `MCP_MESSAGE`
Срабатывает при `POST /message`.

Полезные данные события — JSON:
- `id` — строка `mcp`.
- `method` — HTTP метод.
- `path` — путь.
- `query` — строка запроса.
- `headers` — объект заголовков.
- `body` — строка тела.

## Пример WebSocket‑клиента (1С)

```bsl
ОбъектВК = Новый("AddIn.WebTransport.ws");

Попытка

    Заголовки = "{\"key\":\"value\"}";
    СоединениеУстановлено = ОбъектВК.Подключиться("ws://127.0.0.1:8080", Заголовки);
    Таймаут = 2000;

    Если СоединениеУстановлено Тогда

        СообщениеОтправлено = ОбъектВК.ОтправитьСообщение("Hello World!");
        Сообщить("Результат отправки сообщения: " + СообщениеОтправлено);

        Ответ = ОбъектВК.ПолучитьСообщение(Таймаут);
        Если ЗначениеЗаполнено(Ответ) Тогда
            Сообщить("Сообщение от сервера: " + Ответ);
        Иначе
            Сообщить(СтрШаблон("Сервер не ответил в течение %1 миллисекунд!", Таймаут));
        КонецЕсли;

        ОбъектВК.Отключиться();

    КонецЕсли;

Исключение

    Сообщить(ОбъектВК.ОписаниеОшибки);

КонецПопытки;
```

## Пример HTTP‑сервера (1С)

Пример запуска HTTP‑сервера и обработки входящих запросов через внешние события.

```bsl
Перем Сервер;

Процедура ПриОткрытии()
    Сервер = Новый("AddIn.WebTransport.http");
    Если Не Сервер.ЗапуститьHTTP("127.0.0.1:8088") Тогда
        Сообщить("Не удалось запустить HTTP: " + Сервер.ОписаниеОшибки);
    КонецЕсли;
КонецПроцедуры

Процедура ПриЗакрытии()
    Если ЗначениеЗаполнено(Сервер) Тогда
        Сервер.ОстановитьHTTP();
    КонецЕсли;
КонецПроцедуры

// Обработчик внешних событий компоненты (источник "WebTransport")
Процедура ВнешнееСобытие(Источник, Событие, Данные, ДопПараметр)
    Если Источник <> "WebTransport" Тогда
        Возврат;
    КонецЕсли;

    Если Событие = "HTTP" Тогда
        Запрос = ПрочитатьJSON(Данные);
        ТелоОтвета = СтрШаблон("OK %1 %2", Запрос.method, Запрос.path);
        Сервер.ОтправитьHTTPОтвет(Запрос.id, 200, "{\"Content-Type\":\"text/plain; charset=utf-8\"}", ТелоОтвета);
    ИначеЕсли Событие = "SSE_OPEN" Тогда
        Сессия = ПрочитатьJSON(Данные);
        Сервер.ОтправитьSSE(Сессия.id, "connected");
    ИначеЕсли Событие = "MCP_MESSAGE" Тогда
        // Обработка MCP сообщений при необходимости
    КонецЕсли;
КонецПроцедуры
```
