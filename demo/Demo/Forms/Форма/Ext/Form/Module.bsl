&НаКлиенте
Перем ЭкземплярКомпонентыHTTP;
&НаКлиенте
Перем MCP_Компонента;
&НаКлиенте
Перем MCP_SSE_Сессии;
&НаКлиенте
Перем HTTP_ОтветТела;

&НаКлиенте
Асинх Процедура ПриОткрытии(Отказ)
	
	НомерПорта = 8081;
	Логировать = Истина;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗапуститьHTTPСервер(Команда)
	
	ПодключитьКомпоненту();
	
	ЭкземплярКомпонентыHTTP = Новый("AddIn.WebTransport.http");
	
	ЭкземплярКомпонентыHTTP.ЗапуститьHTTP(АдресПрослушивания());
	
КонецПроцедуры

&НаКлиенте
Асинх Процедура ЗапуститьMCPСервер(Команда)
	АдресПрослушивания = АдресПрослушивания();
	
	Ждать ПодключитьКомпоненту();
	
	MCP_Компонента = Новый("AddIn.WebTransport.mcp");
	MCP_Компонента.ЗапуститьHTTP(АдресПрослушивания);
	MCP_SSE_Сессии = Новый Соответствие;
	
	MCP_Лог(СтрШаблон("Server started on %1", АдресПрослушивания));
	
КонецПроцедуры

&НаКлиенте
Процедура ОстановитьMCP(Команда)
	MCP_ОстановитьСервер();
КонецПроцедуры

&НаКлиенте
Процедура ВнешнееСобытие(Источник, Событие, ЗапросJSON)
	Если Логировать = Неопределено Тогда
		Логировать = Истина;
	КонецЕсли;
	MCP_Лог(СтрШаблон("External event source=%1 event=%2 data=%3", Источник, Событие, ЗапросJSON));
	
	Если Источник = "WebTransport" Тогда
		Если Событие = "HTTP" Тогда
			MCP_ОбработатьHttpСобытие(ЗапросJSON);
		ИначеЕсли Событие = "MCP_MESSAGE" Тогда
			MCP_ОбработатьMcpСообщение(ЗапросJSON);
		ИначеЕсли Событие = "SSE_OPEN" Тогда
			MCP_ОбработатьSseOpen(ЗапросJSON);
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура Остановить(Команда)
	ЭкземплярКомпонентыHTTP.ОстановитьHTTP();
	ЭкземплярКомпонентыHTTP = Неопределено;
КонецПроцедуры

&НаКлиенте
Асинх Функция ПодключитьКомпоненту()
	
	Подключено = Ждать ПодключитьВнешнююКомпонентуАсинх("ВнешняяОбработка.Demo.Макет.Компонента", "WebTransport", ТипВнешнейКомпоненты.Native, ТипПодключенияВнешнейКомпоненты.НеИзолированно);
	
	Если Не Подключено Тогда
		Ждать УстановитьВнешнююКомпонентуАсинх("ВнешняяОбработка.Demo.Макет.Компонента");
		Подключено = Ждать ПодключитьВнешнююКомпонентуАсинх("ВнешняяОбработка.Demo.Макет.Компонента", "WebTransport", ТипВнешнейКомпоненты.Native, ТипПодключенияВнешнейКомпоненты.НеИзолированно);
	КонецЕсли;
	
	Если Не Подключено Тогда
		ВызватьИсключение "Не удалось подключить внешнюю компоненту.";
	КонецЕсли;
	
	Возврат Истина;
КонецФункции

&НаКлиенте
Функция АдресПрослушивания()
	Возврат "127.0.0.1:" + Формат(НомерПорта, "ЧГ=0");
КонецФункции

&НаКлиенте
Функция ПрочитатьJSONСтроку(ТекстJSON)
	ЧтениеJSON = Новый ЧтениеJSON;
	ЧтениеJSON.УстановитьСтроку(ТекстJSON);
	Возврат ПрочитатьJSON(ЧтениеJSON, Истина);
КонецФункции

&НаКлиенте
Функция ПрочитатьJSONСтрокуБезОшибок(ТекстJSON, ЗначениеПоУмолчанию = Неопределено)
	Попытка
		Возврат ПрочитатьJSONСтроку(ТекстJSON);
	Исключение
		Возврат ЗначениеПоУмолчанию;
	КонецПопытки;
КонецФункции

&НаКлиенте
Функция ПолучитьЗначениеJSON(Данные, Имя)
	Если ТипЗнч(Данные) = Тип("Структура") Тогда
		Значение = Неопределено;
		Если Данные.Свойство(Имя, Значение) Тогда
			Возврат Значение;
		КонецЕсли;
	КонецЕсли;
	Возврат "";
КонецФункции

///////////////////////////////////////////////////////////////////////////////
// MCP client (Model Context Protocol) over WebTransportAddIn
///////////////////////////////////////////////////////////////////////////////

&НаКлиенте
Функция MCP_СоздатьКлиент(Адрес, Заголовки = "", ТаймаутМс = 10000) Экспорт
	ПодключитьКомпоненту();
	Компонента = Новый("AddIn.WebTransport.ws");
	Клиент = Новый Структура(
		"Компонента,Адрес,Заголовки,ТаймаутМс,СледующийИД,Ожидающие,Уведомления",
		Компонента,
		Адрес,
		Заголовки,
		ТаймаутМс,
		1,
		Новый Соответствие,
		Новый Массив
	);
	Возврат Клиент;
КонецФункции

&НаКлиенте
Функция MCP_Подключиться(Клиент) Экспорт
	Возврат Клиент.Компонента.Подключиться(Клиент.Адрес, Клиент.Заголовки);
КонецФункции

&НаКлиенте
Процедура MCP_Отключиться(Клиент) Экспорт
	Клиент.Компонента.Отключиться();
КонецПроцедуры

&НаКлиенте
Функция MCP_Инициализировать(Клиент, ИмяКлиента, ВерсияКлиента) Экспорт
	Параметры = Новый Структура;
	Параметры.Вставить("protocolVersion", "2025-11-25");
	Параметры.Вставить("clientInfo", Новый Структура("name,version", ИмяКлиента, ВерсияКлиента));
	Параметры.Вставить("capabilities", Новый Структура);

	Ответ = MCP_ОтправитьЗапрос(Клиент, "initialize", Параметры);
	MCP_ОтправитьУведомление(Клиент, "initialized", Неопределено);
	Возврат Ответ;
КонецФункции

&НаКлиенте
Функция MCP_СписокИнструментов(Клиент) Экспорт
	Возврат MCP_ОтправитьЗапрос(Клиент, "tools/list", Новый Структура);
КонецФункции

&НаКлиенте
Функция MCP_ВызватьИнструмент(Клиент, ИмяИнструмента, Аргументы) Экспорт
	Параметры = Новый Структура("name,arguments", ИмяИнструмента, Аргументы);
	Возврат MCP_ОтправитьЗапрос(Клиент, "tools/call", Параметры);
КонецФункции

&НаКлиенте
Функция MCP_СписокРесурсов(Клиент) Экспорт
	Возврат MCP_ОтправитьЗапрос(Клиент, "resources/list", Новый Структура);
КонецФункции

&НаКлиенте
Функция MCP_ПрочитатьРесурс(Клиент, URI) Экспорт
	Параметры = Новый Структура("uri", URI);
	Возврат MCP_ОтправитьЗапрос(Клиент, "resources/read", Параметры);
КонецФункции

&НаКлиенте
Функция MCP_СписокПромптов(Клиент) Экспорт
	Возврат MCP_ОтправитьЗапрос(Клиент, "prompts/list", Новый Структура);
КонецФункции

&НаКлиенте
Функция MCP_ПолучитьПромпт(Клиент, ИмяПромпта, Аргументы = Неопределено) Экспорт
	Параметры = Новый Структура("name", ИмяПромпта);
	Если Аргументы <> Неопределено Тогда
		Параметры.Вставить("arguments", Аргументы);
	КонецЕсли;
	Возврат MCP_ОтправитьЗапрос(Клиент, "prompts/get", Параметры);
КонецФункции

&НаКлиенте
Функция MCP_ОтправитьЗапрос(Клиент, Метод, Параметры) Экспорт
	ИД = Клиент.СледующийИД;
	Клиент.СледующийИД = Клиент.СледующийИД + 1;

	Запрос = MCP_СформироватьЗапросJSON(ИД, Метод, Параметры);
	Клиент.Компонента.ОтправитьСообщение(Запрос);

	Ответ = MCP_ОжидатьОтвет(Клиент, ИД);
	Если MCP_ПолучитьСвойство(Ответ, "error", Неопределено) <> Неопределено Тогда
		ВызватьИсключение "MCP ошибка: " + MCP_ЗаписатьJSON(Ответ.error);
	КонецЕсли;
	Возврат Ответ;
КонецФункции

&НаКлиенте
Процедура MCP_ОтправитьУведомление(Клиент, Метод, Параметры) Экспорт
	Уведомление = MCP_СформироватьУведомлениеJSON(Метод, Параметры);
	Клиент.Компонента.ОтправитьСообщение(Уведомление);
КонецПроцедуры

&НаКлиенте
Функция MCP_ОжидатьОтвет(Клиент, ИД) Экспорт
	Ключ = Строка(ИД);
	Ответ = Неопределено;
	Если Клиент.Ожидающие.Свойство(Ключ, Ответ) Тогда
		Клиент.Ожидающие.Удалить(Ключ);
		Возврат Ответ;
	КонецЕсли;

	Пока Истина Цикл
		Сообщение = Клиент.Компонента.ПолучитьСообщение(Клиент.ТаймаутМс);
		Если Не ЗначениеЗаполнено(Сообщение) Тогда
			ВызватьИсключение "Таймаут ожидания MCP ответа";
		КонецЕсли;

		Данные = ПрочитатьJSONСтроку(Сообщение);
		Если ТипЗнч(Данные) = Тип("Структура") Тогда
			ПолученныйИД = Неопределено;
			Если Данные.Свойство("id", ПолученныйИД) Тогда
				КлючОтвета = Строка(ПолученныйИД);
				Если КлючОтвета = Ключ Тогда
					Возврат Данные;
				Иначе
					Клиент.Ожидающие.Вставить(КлючОтвета, Данные);
				КонецЕсли;
			Иначе
				Клиент.Уведомления.Добавить(Данные);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
КонецФункции

&НаКлиенте
Функция MCP_СформироватьЗапросJSON(ИД, Метод, Параметры)
	Данные = Новый Структура("jsonrpc,id,method", "2.0", ИД, Метод);
	Если Параметры <> Неопределено Тогда
		Данные.Вставить("params", Параметры);
	КонецЕсли;
	Возврат MCP_ЗаписатьJSON(Данные);
КонецФункции

&НаКлиенте
Функция MCP_СформироватьУведомлениеJSON(Метод, Параметры)
	Данные = Новый Структура("jsonrpc,method", "2.0", Метод);
	Если Параметры <> Неопределено Тогда
		Данные.Вставить("params", Параметры);
	КонецЕсли;
	Возврат MCP_ЗаписатьJSON(Данные);
КонецФункции

&НаКлиенте
Функция MCP_ЗаписатьJSON(Данные)
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, Данные);
	Возврат ЗаписьJSON.Закрыть();
КонецФункции

&НаКлиенте
Функция MCP_ПолучитьСвойство(Данные, Имя, ЗначениеПоУмолчанию)
	Если ТипЗнч(Данные) = Тип("Структура") Тогда
		Значение = ЗначениеПоУмолчанию;
		Если Данные.Свойство(Имя, Значение) Тогда
			Возврат Значение;
		КонецЕсли;
	КонецЕсли;
	Если ТипЗнч(Данные) = Тип("Соответствие") Тогда
		Значение = Данные.Получить(Имя);
		Если Значение <> Неопределено Тогда
			Возврат Значение;
		КонецЕсли;
	КонецЕсли;
	Возврат ЗначениеПоУмолчанию;
КонецФункции

///////////////////////////////////////////////////////////////////////////////
// MCP server (HTTP + SSE)
///////////////////////////////////////////////////////////////////////////////

&НаКлиенте
Процедура MCP_Лог(Текст)
	Если Логировать = Ложь Тогда
		Возврат;
	КонецЕсли;
	Время = Формат(ТекущаяДата(), "ДФ=yyyy-MM-dd HH:mm:ss");
	Сообщить(СтрШаблон("[MCP %1] %2", Время, Текст));
КонецПроцедуры

&НаКлиенте
Процедура MCP_ОстановитьСервер() Экспорт
	Если MCP_Компонента <> Неопределено Тогда
		MCP_Компонента.ОстановитьHTTP();
		MCP_Компонента = Неопределено;
	КонецЕсли;
	MCP_SSE_Сессии = Новый Соответствие;
	MCP_Лог("Server stopped");
КонецПроцедуры

&НаКлиенте
Процедура MCP_ОбработатьSseOpen(ЗапросJSON)
	Если MCP_SSE_Сессии = Неопределено Тогда
		MCP_SSE_Сессии = Новый Соответствие;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(ЗапросJSON) Тогда
		Возврат;
	КонецЕсли;
	Данные = ПрочитатьJSONСтроку(ЗапросJSON);
	Если ТипЗнч(Данные) <> Тип("Структура") Тогда
		Возврат;
	КонецЕсли;
	Сессия = MCP_ПолучитьСвойство(Данные, "id", "");
	Если ЗначениеЗаполнено(Сессия) Тогда
		MCP_SSE_Сессии.Вставить(Сессия, Истина);
		MCP_Лог(СтрШаблон("SSE open session=%1", Сессия));
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура MCP_ОбработатьHttpСобытие(ЗапросJSON)
	Если ЭкземплярКомпонентыHTTP = Неопределено Тогда
		MCP_Лог("HTTP event ignored: ЭкземплярКомпонентыHTTP is undefined");
		Возврат;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(ЗапросJSON) Тогда
		MCP_Лог("HTTP event ignored: empty request JSON");
		Возврат;
	КонецЕсли;
	MCP_Лог(СтрШаблон("HTTP event data=%1", ЗапросJSON));
	ЗапросДанные = ПрочитатьJSONСтрокуБезОшибок(ЗапросJSON, Неопределено);
	Если ТипЗнч(ЗапросДанные) <> Тип("Структура") И ТипЗнч(ЗапросДанные) <> Тип("Соответствие") Тогда
		MCP_Лог("HTTP event ignored: request is not object");
		Возврат;
	КонецЕсли;
	Идентификатор = ЗапросДанные.Получить("id");
	Если Не ЗначениеЗаполнено(Идентификатор) Тогда
		MCP_Лог("HTTP event ignored: missing id");
		Возврат;
	КонецЕсли;
	ЗаголовкиОтвета = "{""Content-Type"":""text/plain; charset=utf-8""}";
	ТелоОтвета = HTTP_ОтветТела;
	Если Не ЗначениеЗаполнено(ТелоОтвета) Тогда
		ТелоОтвета = ЗапросJSON;
	КонецЕсли;
	ЭкземплярКомпонентыHTTP.ОтправитьHTTPОтвет(Идентификатор, 200, ЗаголовкиОтвета, ТелоОтвета);
КонецПроцедуры

&НаКлиенте
Процедура MCP_ОбработатьMcpСообщение(ЗапросJSON)
	MCP_Лог("MCP_MESSAGE received");
	Если MCP_Компонента = Неопределено Тогда
		MCP_Лог("MCP_MESSAGE ignored: MCP_Компонента is undefined");
		Возврат;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(ЗапросJSON) Тогда
		MCP_Лог("MCP_MESSAGE ignored: empty request JSON");
		Возврат;
	КонецЕсли;
	Попытка
		Запрос = ПрочитатьJSONСтроку(ЗапросJSON);
	Исключение
		MCP_Лог(СтрШаблон("MCP_MESSAGE parse error (outer): %1", ОписаниеОшибки()));
		Возврат;
	КонецПопытки;
	Если ТипЗнч(Запрос) <> Тип("Структура") И ТипЗнч(Запрос) <> Тип("Соответствие") Тогда
		MCP_Лог("MCP_MESSAGE ignored: request is not object");
		Возврат;
	КонецЕсли;
	Сессия = MCP_ПолучитьПараметрИзQuery(Запрос.Получить("query"), "sessionId");
	Если Не ЗначениеЗаполнено(Сессия) Тогда
		MCP_Лог("MCP_MESSAGE ignored: missing sessionId");
		Возврат;
	КонецЕсли;
	Тело = Запрос.Получить("body");
	Если Не ЗначениеЗаполнено(Тело) Тогда
		MCP_Лог("MCP_MESSAGE ignored: missing body");
		Возврат;
	КонецЕсли;
	Попытка
		Сообщение = ПрочитатьJSONСтроку(Тело);
	Исключение
		MCP_Лог(СтрШаблон("MCP_MESSAGE parse error (body): %1", ОписаниеОшибки()));
		Возврат;
	КонецПопытки;
	Метод = MCP_ПолучитьСвойство(Сообщение, "method", "");
	ИД = MCP_ПолучитьСвойство(Сообщение, "id", "");
	MCP_Лог(СтрШаблон("IN session=%1 method=%2 id=%3", Сессия, Метод, ИД));
	Ответ = MCP_ОбработатьJSONRPC(Сообщение);
	Если Ответ = Неопределено Тогда
		Возврат;
	КонецЕсли;
	ОтветJSON = MCP_ЗаписатьJSON(Ответ);
	MCP_Лог(СтрШаблон("OUT session=%1 id=%2 body=%3", Сессия, ИД, ОтветJSON));
	Попытка
		Успех = MCP_Компонента.ОтправитьSSE(Сессия, ОтветJSON);
		MCP_Лог(СтрШаблон("SSE send session=%1 ok=%2", Сессия, Успех));
	Исключение
		MCP_Лог(СтрШаблон("SSE send error session=%1 err=%2", Сессия, ОписаниеОшибки()));
	КонецПопытки;
КонецПроцедуры

&НаКлиенте
Функция MCP_ОбработатьJSONRPC(Сообщение)
	Если ТипЗнч(Сообщение) <> Тип("Структура") И ТипЗнч(Сообщение) <> Тип("Соответствие") Тогда
		Возврат MCP_СформироватьОшибку(Неопределено, -32600, "Invalid Request");
	КонецЕсли;

	Ид = MCP_ПолучитьСвойство(Сообщение, "id", Неопределено);
	Если Ид = Неопределено Тогда
		// Уведомление, ответа не требуется
		Возврат Неопределено;
	КонецЕсли;

	Метод = MCP_ПолучитьСвойство(Сообщение, "method", "");
	Если Не ЗначениеЗаполнено(Метод) Тогда
		Возврат MCP_СформироватьОшибку(Ид, -32600, "Invalid Request");
	КонецЕсли;

	Если Метод = "initialize" Тогда
		Возврат MCP_ОтветИнициализация(Ид);
	КонецЕсли;
	Если Метод = "tools/list" Тогда
		Возврат MCP_ОтветСписокИнструментов(Ид);
	КонецЕсли;
	Если Метод = "tools/call" Тогда
		ПарамВызова = MCP_ПолучитьСвойство(Сообщение, "params", Новый Структура);
		Возврат MCP_ОтветВызовИнструмента(Ид, ПарамВызова);
	КонецЕсли;
	Если Метод = "resources/list" Тогда
		Возврат MCP_ОтветСписокРесурсов(Ид);
	КонецЕсли;
	Если Метод = "resources/read" Тогда
		Возврат MCP_СформироватьОшибку(Ид, -32601, "Resource not found");
	КонецЕсли;
	Если Метод = "prompts/list" Тогда
		Возврат MCP_ОтветСписокПромптов(Ид);
	КонецЕсли;
	Если Метод = "prompts/get" Тогда
		Возврат MCP_СформироватьОшибку(Ид, -32601, "Prompt not found");
	КонецЕсли;

	Возврат MCP_СформироватьОшибку(Ид, -32601, "Method not found");
КонецФункции

&НаКлиенте
Функция MCP_ОтветИнициализация(Ид)
	Ответ = Новый Структура("jsonrpc,id", "2.0", Ид);
	Результат = Новый Структура;
	Результат.Вставить("protocolVersion", "2025-11-25");
	Результат.Вставить("serverInfo", Новый Структура("name,version", "1C MCP Server", "0.1.0"));

	Возможности = Новый Структура;
	Возможности.Вставить("tools", Новый Структура("listChanged", Ложь));
	Возможности.Вставить("resources", Новый Структура("subscribe,listChanged", Ложь, Ложь));
	Возможности.Вставить("prompts", Новый Структура("listChanged", Ложь));
	Результат.Вставить("capabilities", Возможности);

	Ответ.Вставить("result", Результат);
	Возврат Ответ;
КонецФункции

&НаКлиенте
Функция MCP_ОтветСписокИнструментов(Ид)
	Ответ = Новый Структура("jsonrpc,id", "2.0", Ид);
	Инструменты = Новый Массив;

	СхемаАргументов = Новый Структура;
	СхемаАргументов.Вставить("type", "object");
	Свойства = Новый Структура;
	Свойства.Вставить("text", Новый Структура("type", "string"));
	СхемаАргументов.Вставить("properties", Свойства);
	Требуемые = Новый Массив;
	Требуемые.Добавить("text");
	СхемаАргументов.Вставить("required", Требуемые);

	Инструменты.Добавить(Новый Структура(
		"name,description,inputSchema",
		"echo",
		"Echo input text",
		СхемаАргументов
	));

	Ответ.Вставить("result", Новый Структура("tools", Инструменты));
	Возврат Ответ;
КонецФункции

&НаКлиенте
Функция MCP_ОтветВызовИнструмента(Ид, Параметры)
	ИмяИнструмента = MCP_ПолучитьСвойство(Параметры, "name", "");
	Аргументы = MCP_ПолучитьСвойство(Параметры, "arguments", Новый Структура);
	Если ИмяИнструмента = "echo" Тогда
		Текст = MCP_ПолучитьСвойство(Аргументы, "text", "");
		Контент = Новый Массив;
		Контент.Добавить(Новый Структура("type,text", "text", Текст));
		Ответ = Новый Структура("jsonrpc,id", "2.0", Ид);
		Ответ.Вставить("result", Новый Структура("content", Контент));
		Возврат Ответ;
	КонецЕсли;
	Возврат MCP_СформироватьОшибку(Ид, -32601, "Tool not found");
КонецФункции

&НаКлиенте
Функция MCP_ОтветСписокРесурсов(Ид)
	Ответ = Новый Структура("jsonrpc,id", "2.0", Ид);
	Ответ.Вставить("result", Новый Структура("resources", Новый Массив));
	Возврат Ответ;
КонецФункции

&НаКлиенте
Функция MCP_ОтветСписокПромптов(Ид)
	Ответ = Новый Структура("jsonrpc,id", "2.0", Ид);
	Ответ.Вставить("result", Новый Структура("prompts", Новый Массив));
	Возврат Ответ;
КонецФункции

&НаКлиенте
Функция MCP_СформироватьОшибку(Ид, Код, Сообщение)
	Ответ = Новый Структура("jsonrpc,id", "2.0", Ид);
	Ошибка = Новый Структура("code,message", Код, Сообщение);
	Ответ.Вставить("error", Ошибка);
	Возврат Ответ;
КонецФункции

&НаКлиенте
Функция MCP_ПолучитьПараметрИзQuery(Запрос, Имя)
	Если Не ЗначениеЗаполнено(Запрос) Тогда
		Возврат "";
	КонецЕсли;
	Для Каждого Пара Из СтрРазделить(Запрос, "&") Цикл
		Если Не ЗначениеЗаполнено(Пара) Тогда
			Продолжить;
		КонецЕсли;
		ПозицияРавно = Найти(Пара, "=");
		Если ПозицияРавно <= 0 Тогда
			Продолжить;
		КонецЕсли;
		Ключ = Лев(Пара, ПозицияРавно - 1);
		Значение = Сред(Пара, ПозицияРавно + 1);
		Если Ключ = Имя Тогда
			Возврат Значение;
		КонецЕсли;
	КонецЦикла;
	Возврат "";
КонецФункции


